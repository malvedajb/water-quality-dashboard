window.map = null;
window.markersLayer = null;

window.initMap = async function initMap() {
  window.map = L.map("map", { zoomControl: true }).setView([14.25, 121.3], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(window.map);

  window.markersLayer = L.layerGroup().addTo(window.map);

  // Approx boundary of Laguna Lake
  const approxBoundary = {
    type: "Feature",
    properties: { name: "Laguna Lake (Approx.)" },
    geometry: {
      type: "Polygon",
      coordinates: [[
        [
              121.18121112955816,
              14.188336173498442
            ],
            [
              121.21130583108732,
              14.178291532791263
            ],
            [
              121.2241330833998,
              14.180683156990781
            ],
            [
              121.23696033571213,
              14.197423819875212
            ],
            [
              121.24140053843536,
              14.197423819875212
            ],
            [
              121.26310819619596,
              14.189292795220837
            ],
            [
              121.26902846649307,
              14.1940757862439
            ],
            [
              121.2769221602249,
              14.191684303354194
            ],
            [
              121.29172283597018,
              14.196467243887653
            ],
            [
              121.30208330899228,
              14.20220663920172
            ],
            [
              121.31639062887848,
              14.222771610563925
            ],
            [
              121.3223108991773,
              14.233292500579225
            ],
            [
              121.34155177764592,
              14.241421943625255
            ],
            [
              121.34648533622658,
              14.25672363037215
            ],
            [
              121.39828770133516,
              14.289236265992159
            ],
            [
              121.40026112476818,
              14.3021443922744
            ],
            [
              121.41555515637083,
              14.304534704695968
            ],
            [
              121.4111149536476,
              14.291626715650679
            ],
            [
              121.43676945827241,
              14.291626715650679
            ],
            [
              121.43627610241504,
              14.297841765853633
            ],
            [
              121.43874288170531,
              14.314573739159798
            ],
            [
              121.43676945827241,
              14.325568357167441
            ],
            [
              121.4234488501026,
              14.337040427639892
            ],
            [
              121.43775616998886,
              14.344688148509647
            ],
            [
              121.45206348987676,
              14.334172465040481
            ],
            [
              121.46094389532334,
              14.323656288377649
            ],
            [
              121.4594638277494,
              14.314095700074532
            ],
            [
              121.4722910800619,
              14.317919984259177
            ],
            [
              121.47327779177834,
              14.32843642979752
            ],
            [
              121.47969141793453,
              14.3489898767926
            ],
            [
              121.47623792692605,
              14.361894565850847
            ],
            [
              121.46735752147947,
              14.384356508310532
            ],
            [
              121.45699704845748,
              14.39056898746793
            ],
            [
              121.45354355745064,
              14.39869273788426
            ],
            [
              121.43578274655596,
              14.3967812937952
            ],
            [
              121.42788905282595,
              14.39869273788426
            ],
            [
              121.43035583211622,
              14.387223827854314
            ],
            [
              121.41999535909423,
              14.402037725645243
            ],
            [
              121.4091415302147,
              14.3967812937952
            ],
            [
              121.4091415302147,
              14.380533358338994
            ],
            [
              121.40223454820108,
              14.365240104526933
            ],
            [
              121.39680763376134,
              14.351857649751665
            ],
            [
              121.37559333185982,
              14.340864320696227
            ],
            [
              121.33760493078,
              14.313617659971456
            ],
            [
              121.32576439018413,
              14.29592946101016
            ],
            [
              121.31047035857972,
              14.288280079016047
            ],
            [
              121.30307002070708,
              14.299754054430053
            ],
            [
              121.30405673242359,
              14.323656288377649
            ],
            [
              121.31589727302111,
              14.337518417839505
            ],
            [
              121.32083083160182,
              14.351379690141968
            ],
            [
              121.32773781361703,
              14.37671014295951
            ],
            [
              121.33809828663743,
              14.404904818099865
            ],
            [
              121.33168466048124,
              14.433095930105182
            ],
            [
              121.3262577460415,
              14.460328021205683
            ],
            [
              121.30405673242359,
              14.471315464148162
            ],
            [
              121.30208330899228,
              14.48421307286712
            ],
            [
              121.28382914223846,
              14.481347002385277
            ],
            [
              121.27593544850845,
              14.501886355549388
            ],
            [
              121.27445538093451,
              14.514782185609107
            ],
            [
              121.26360155205344,
              14.503796896281443
            ],
            [
              121.25669457003983,
              14.513826964698552
            ],
            [
              121.25620121418075,
              14.494721681061819
            ],
            [
              121.2542277907495,
              14.498542869619499
            ],
            [
              121.24238725015181,
              14.501408717791577
            ],
            [
              121.23597362399568,
              14.490900426621707
            ],
            [
              121.2354802681383,
              14.48278004225513
            ],
            [
              121.23696033571213,
              14.475614750344818
            ],
            [
              121.23054670955588,
              14.472270868277064
            ],
            [
              121.22363972754243,
              14.477047827237726
            ],
            [
              121.22067959239297,
              14.469404643555691
            ],
            [
              121.22215965996685,
              14.424973433120925
            ],
            [
              121.21722610138613,
              14.414461526774858
            ],
            [
              121.21278589866284,
              14.415894997746932
            ],
            [
              121.20735898422151,
              14.430229200295159
            ],
            [
              121.20933240765447,
              14.435484843415281
            ],
            [
              121.19946529049145,
              14.44360695686197
            ],
            [
              121.20390549321473,
              14.446951270331553
            ],
            [
              121.19354502019263,
              14.461283472603313
            ],
            [
              121.17973106198428,
              14.466060656562647
            ],
            [
              121.18170448541724,
              14.489945091331677
            ],
            [
              121.16591709795546,
              14.495676972992115
            ],
            [
              121.1639436745225,
              14.510006028446753
            ],
            [
              121.14864964291974,
              14.516692603675224
            ],
            [
              121.12398185000978,
              14.535795990721212
            ],
            [
              121.11460808870584,
              14.527199670785507
            ],
            [
              121.09734063366852,
              14.524811744815807
            ],
            [
              121.08895358407943,
              14.511438883000665
            ],
            [
              121.0711927731864,
              14.509050786926181
            ],
            [
              121.06527250288747,
              14.496632272189984
            ],
            [
              121.05688545329843,
              14.467493795130991
            ],
            [
              121.0504718271423,
              14.402515565555262
            ],
            [
              121.05885887673139,
              14.376710131566298
            ],
            [
              121.07168612904371,
              14.371453103648008
            ],
            [
              121.06527250288747,
              14.359504853350032
            ],
            [
              121.09092700751233,
              14.35520332705903
            ],
            [
              121.09536721023721,
              14.342298252378683
            ],
            [
              121.10967453012358,
              14.33273845858929
            ],
            [
              121.12299513829498,
              14.320310117396488
            ],
            [
              121.12743534101827,
              14.30405663284877
            ],
            [
              121.13976923747157,
              14.292104791136339
            ],
            [
              121.15012971049367,
              14.277761742710226
            ],
            [
              121.16739716552928,
              14.26246148387466
            ],
            [
              121.16986394482126,
              14.24524745119632
            ],
            [
              121.18910482328988,
              14.230423204120967
            ],
            [
              121.18515797642402,
              14.21416323399913
            ],
            [
              121.18121112955816,
              14.188336173498442
            ]
      ]]
    }
  };

  // Map fill for Laguna Lake boundary
  const boundaryLayer = L.geoJSON(approxBoundary, {
  style: {
    color: "#ffcb6aff",
    weight: 4,
    fillOpacity: 0.20,
    dashArray: "10, 15"   // â† dashed line
  }
}).addTo(window.map);

  window.map.fitBounds(boundaryLayer.getBounds(), { padding: [10, 10] });

  // Add station markers
  window.STATIONS.forEach((st) => {
    const marker = L.circleMarker([st.lat, st.lng], {
      radius: 7,
      weight: 2,
      color: "#6aa6ff",
      fillColor: "#6aa6ff",
      fillOpacity: 0.35
    });

    marker.on("click", () => window.selectStation(st.id, true));
    marker.bindTooltip(st.name, { direction: "top", opacity: 0.9 });

    marker.addTo(window.markersLayer);
    st.__marker = marker;
  });
};
